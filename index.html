<html>

<head>
  <style>
    .gridlines line {
      stroke: #bbb;
    }

    .gridlines .domain {
      stroke: none;
    }
  </style>
</head>

<body style="margin: 75">
  <h3>
    Countries by Coastline Distance and Water Sport Medals in 2024 Olympics
    <script src="https://d3js.org/d3.v7.min.js"></script>
  </h3>
  <p>
    <br />
    <svg height=650 width=650 style="margin-bottom:50px"></svg>
    <script>
      // Coastlines Mappings

      let coastlines = new Map()

      d3.csv('../data/coastlines.csv').then((data) => {
        data.forEach((d, i) => {
          coastlines.set(d.country, Number(d.coastline_wf));
        })
      })



      // GDP data
      //let revelant_countries = ['Argentina', 'Australia', 'Brazil', 'Canada', 'China', 'Croatia', 'Cuba', 'Cyprus', 'Czechia', 'Denmark', 'France', 'Germany', 'Great Britain', 'Greece', '"Hong Kong, China"', 'Hungary', 'Ireland', 'Israel', 'Italy', 'Japan', 'Korea', 'Lithuania', 'Netherlands', 'New Zealand', 'Norway', 'Peru', 'Poland', 'Republic of Moldova', 'Romania', 'Serbia', 'Singapore', 'Slovakia', 'South Africa', 'Spain', 'Sweden', 'Switzerland', 'Ukraine', 'United States']

      let gdp_data = new Map();

      d3.csv('../data/cleaned_gdp.csv').then((data) => {
        data.forEach((d) => {
          if (d.year == "2023") {
            gdp_data.set(d.country, Number(d.GDP));
          }
        });
      });

      // Chart Area

      const svg = d3.select('svg');
      const width = svg.attr('width');
      const height = svg.attr('height');
      const margins = { top: 60, right: 20, bottom: 100, left: 80 };
      const chartWidth = width - margins.left - margins.right;
      const chartHeight = height - margins.top - margins.bottom;

      let defs = svg.append("defs");

      let chartArea = svg.append('g')
        .attr('transform', `translate(${margins.left},${margins.top})`);

      d3.csv('../data/water_sports.csv').then((data) => {

        // Medal Counts

        let medal_counts = new Map();

        data.forEach((d, i) => {
          if (medal_counts.has(d.country)) {
            medal_counts.set(d.country, medal_counts.get(d.country) + 1)
          } else {
            medal_counts.set(d.country, 1);
          }
        })

        //list of countries
        console.log("Medal Counts Map:", medal_counts);

        const medal_count_array = Array.from(medal_counts.values());
        const coastline_array = Array.from(coastlines.values());
        const filtered_array = coastline_array.filter(d => d > 0);

        // Extents and Scales
        const xExtent = d3.extent(filtered_array);
        xExtent[1] = xExtent[1] + 60000;
        const xScale = d3.scaleLog().domain(xExtent)
          .range([0, chartWidth]);

        const yExtent = d3.extent(medal_count_array);
        // added a lil more to fit the large circle on the chart area
        yExtent[1] = yExtent[1] + 20;
        const yScale = d3.scaleLog().domain(yExtent)
          .range([chartHeight, 0]);

        // Labels

        svg.append("text")
          .attr("class", "y label")
          .attr("text-anchor", "middle")
          .attr("x", -chartHeight / 2 - margins.top)
          .attr("y", 20)
          .attr("transform", "rotate(-90)")
          .text("Medals in Water Sports (Logarithmic)");

        svg.append("text")
          .attr("class", "x label")
          .attr("text-anchor", "middle")
          .attr("x", chartWidth / 2 + margins.left)
          .attr("y", height - 20)
          .text("Coastline Distance (km) (Logarithmic)");

        // Axes

        let leftAxis = d3.axisLeft(yScale);
        svg.append('g')
          .attr("class", "axis")
          .attr('transform', `translate(${margins.left - 10},${margins.top})`)
          .call(leftAxis)

        let bottomAxis = d3.axisBottom(xScale);
        svg.append('g')
          .attr('class', 'axis')
          .attr('transform', `translate(${margins.left},${chartHeight + margins.top + 10})`)
          .call(bottomAxis);

        // Gridlines

        let leftGridlines = d3.axisLeft(yScale)
          .tickSize(-chartWidth - 10)
          .tickFormat('');
        svg.append('g')
          .attr("class", "gridlines")
          .attr('transform', `translate(${margins.left - 10},${margins.top})`)
          .call(leftGridlines);

        let bottomGridlines = d3.axisBottom(xScale)
          .tickSize(-chartHeight - 10)
          .tickFormat('');
        svg.append('g')
          .attr("class", "gridlines")
          .attr('transform', `translate(${margins.left},${chartHeight + margins.top + 10})`)
          .call(bottomGridlines);

        // Circles & flags
        // clips the given country flag onto the current circle
        function selectFlag(country, r, x, y) {
          // console.log("country name: " + country);
          pattern = defs.append("pattern")
            .attr("id", country)
            .attr("width", r * 2)
            .attr("height", r * 2)
            .attr("x", x + r)
            .attr("y", y + r)
            .attr("patternUnits", "userSpaceOnUse");
          pattern.append("svg:image")
            .attr("xlink:href", '../flags/' + country + '.png')
            .attr("width", r * 2)
            .attr("height", r * 2)
            .attr("x", 0)
            .attr("y", 0);

          return "url(#" + country + ")"
        }

        const minRadius = 5;
        medal_counts.forEach((medals, country) => {
          if (coastlines.has(country) && gdp_data.has(country)) {
            cx = xScale(coastlines.get(country)) || 0;
            cy = yScale(medals);
            // console.log(country + " x: " + cx);
            // console.log(country + " y: " + cy);
            r = Math.max(Math.sqrt(gdp_data.get(country)) / 100000, minRadius);
            chartArea.append('circle')
              .attr('cx', cx)
              .attr('cy', cy)
              .attr('r', r)
              .style('fill', selectFlag(country.replace(' ', '_'), r, cx, cy))
              .style('stroke', 'black')
              .style('stroke-width', 1);
          }
        });
        chartArea.raise();
      });

      console.log("Coastlines Map:", coastlines);
      console.log("GDP Data Map:", gdp_data);


    </script>

  </p>
</body>

</html>